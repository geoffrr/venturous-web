---
import { plainify } from "@/lib/utils/textConverter";
import ImageMod from "./ImageMod.astro";
import Social from "./Social.astro";
import { CiAt } from "react-icons/ci";
import { PiDot } from "react-icons/pi";
import {
  FaEnvelope,
  FaPhone,
  FaLocationDot,
  FaGlobe,
  FaLinkedin,
  FaDownload,
  FaPaperPlane,
  FaBriefcase,
  FaShare,
  FaMessage,
  FaUser,
} from "react-icons/fa6";

const { data } = Astro.props;
const {
  title,
  image,
  social,
  description,
  region,
  email,
  email_parts,
  phone,
  location,
  locationFull,
  website,
  company,
  jobTitle,
} = data.data;

// Helper functions for phone and email
const getPhoneNumber = () => {
  if (!phone) return "";
  const { country, area, first, last } = phone;
  return `${country} (${area}) ${first}-${last}`;
};

const getPhoneForCall = () => {
  if (!phone) return "";
  const { country, area, first, last } = phone;
  return `${country}${area}${first}${last}`;
};

const getEmailDisplay = () => {
  if (email) return email;
  if (email_parts) {
    const { username, domain, tld } = email_parts;
    return `${username}@${domain}.${tld}`;
  }
  return "";
};

const getEmailForMailto = () => {
  if (email) return email;
  return getEmailDisplay();
};
---

<div class="min-h-screen flex items-center justify-center p-4">
  <div class="w-full max-w-md mx-auto">
    <div class="w-full shadow-sm dark:shadow-darkmode-border overflow-hidden bg-body dark:bg-darkmode-body">
      {/* Header - Clean minimal design */}
      <div class="p-0 pt-6 z-20 bg-gradient-to-br from-[var(--color-primary-dim)] to-[var(--color-primary)] dark:from-[var(--color-darkmode-primary-dim)] dark:to-[var(--color-darkmode-light-dim)]">
        <!-- <div class="p-0 pt-6 z-20 bg-gradient-to-br from-[var(--color-primary-dim)] to-[var(--color-light)] dark:from-[var(--color-darkmode-primary-dim)] dark:to-[var(--color-darkmode-light-dim)]"> -->
        <div class="mt-0 w-40 h-40 mx-auto">
          {image ? (
            <ImageMod
              src={image}
              alt={title}
              width={160}
              height={160}
              format="webp"
              class="mx-auto clip"
            />
          ) : (
            <div class="w-40 h-40 mx-auto rounded-full bg-gray-300 dark:bg-gray-700 flex items-center justify-center">
              <FaUser className="w-24 h-24 text-gray-400" />
            </div>
          )}
        </div>
        <div class="py-4 text-center">
          <div class="flex flex-col items-center gap-2">
            <h1 class="text-2xl text-white mb-0 leading-tight">{title}</h1>
            <span>
              {company && <p class="text-base text-white">{company}</p>}
              {jobTitle && <p class="text-base text-white">{jobTitle}</p>}
            </span>
          </div>
        </div>
        {/* Quick Action Buttons */}
        <div class="grid grid-cols-2">
          {phone && (
            <a
              href={`tel:${getPhoneForCall()}`}
              class="flex flex-col items-center justify-center py-2 hover-secondary-gradient border-t border-r border-white/20 transition-colors"
            >
              <FaPhone className="w-5 h-5 text-white mb-1" />
              <span class="text-xs text-white">CALL</span>
            </a>
          )}
          {getEmailForMailto() && (
            <a
              href={`mailto:${getEmailForMailto()}`}
              class="flex flex-col items-center justify-center py-2 border-t border-white/20 transition-colors hover-secondary-gradient"
            >
              <FaPaperPlane className="w-5 h-5 text-white mb-1" />
              <span class="text-xs text-white">EMAIL</span>
            </a>
          )}
        </div>
      </div>

      <div class="p-6">
        {/* Bio Section */}
        {description && (
          <div class="mb-6">
            <p class="text-[15px] text-text-dark dark:text-darkmode-text-dark leading-relaxed whitespace-pre-line">
              {plainify(description)}
            </p>
          </div>
        )}

        {/* Save Contact Data Section */}
        <div class="mb-6">
          <div class="space-y-3">
            {phone && (
              <a
                id="download-vcard-btn"
                href="#"
                class="btn btn-secondary clip w-full flex items-center justify-center gap-2 cursor-pointer lg:hidden"
              >
                <FaDownload className="w-4 h-4" />
                Download vCard
              </a>
            )}
            <a
              id="share-btn"
              href="#"
              class="btn btn-secondary clip w-full flex items-center justify-center gap-2 cursor-pointer "
            >
              <FaShare className="w-4 h-4" />
              <span id="share-text">Share</span>
            </a>
          </div>
        </div>

        {/* Contact Information */}
        <div class="space-y-0 mb-6">
          {/* Phone Section */}
          {phone && (
            <div class="flex items-center gap-6">
              <FaPhone className="w-5 h-5 text-gray-400 shrink-0" />
              <div class="py-4 border-b border-border dark:border-darkmode-border w-full">
                <div class="text-md text-text-dark dark:text-darkmode-text-dark flex gap-0">
                  <span class="mr-1">{phone.country} </span>
                  <span class="mr-1">({phone.area}) </span>
                  <span> {phone.first}-</span>
                  <span>{phone.last}</span>
                </div>
                <p class="text-sm text-gray-500 dark:text-gray-400">Mobile</p>
              </div>
            </div>
          )}

          {/* Email Section */}
          {getEmailDisplay() && (
            <div class="flex items-center gap-6">
              <FaEnvelope className="w-5 h-5 text-gray-400 shrink-0" />
              <div class="py-4 border-b border-border dark:border-darkmode-border w-full">
                <div
                  id="email-display"
                  class="text-text-dark dark:text-darkmode-text-dark flex items-center gap-0 cursor-pointer hover:text-[#01afb6] transition-colors select-none"
                  title="Click to copy email"
                  data-email={getEmailDisplay()}
                >
                  {email_parts ? (
                    <span class="flex flex-row items-center">
                      <span>{email_parts.username}</span>
                      <span class="flex" style="line-height: 1;">
                        <CiAt className="w-4 h-4 mx-0.5" />
                      </span>
                      <span class="mr-0">{email_parts.domain}</span>
                      <span class="w-1.5 h-4 mt-1.5 flex justify-center items-end overflow-clip" style="display: flex; justify-content: center; align-items: end; overflow: clip;">
                        <span style="width: 1rem; height: 1rem; display: block; position: relative; overflow: visible;">
                          <PiDot className="h-4 w-4 mx-0 px-0 align-middle" />
                        </span>
                      </span>
                      <span>{email_parts.tld}</span>
                    </span>
                  ) : (
                    <span>{email}</span>
                  )}
                </div>
                <p id="email-label" class="text-sm text-gray-500 dark:text-gray-400">Email</p>
              </div>
            </div>
          )}

          {/* Company Section */}
          {company && (
            <div class="flex items-center gap-6">
              <FaBriefcase className="w-5 h-5 text-gray-400 shrink-0" />
              <div class="py-4 w-full border-b border-border dark:border-darkmode-border">
                <span class="text-text-dark dark:text-darkmode-text-dark">{company}</span>
                {jobTitle && (
                  <p class="text-sm text-gray-500 dark:text-gray-400">{jobTitle}</p>
                )}
              </div>
            </div>
          )}

          {/* Location Section */}
          {locationFull && (
            <div class="flex items-center gap-6">
              <FaLocationDot className="w-5 h-5 text-gray-400 shrink-0" />
              <div class="py-4 w-full border-b border-border dark:border-darkmode-border">
                <div class="text-text-dark dark:text-darkmode-text-dark whitespace-pre-line">
                  {locationFull}
                </div>
              </div>
            </div>
          )}

          {/* Website Section */}
          {website && (
            <div class="flex items-center gap-6">
              <FaGlobe className="w-5 h-5 text-gray-400 shrink-0" />
              <div class="py-4 w-full border-b border-border dark:border-darkmode-border">
                <a
                  href={`https://${website}`}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="text-text-dark dark:text-darkmode-text-dark hover:text-[#01afb6] transition-colors"
                >
                  {website}
                </a>
                <p class="text-sm text-gray-500 dark:text-gray-400">Website</p>
              </div>
            </div>
          )}
        </div>

        {/* Social Media Section */}
        {social && social.length > 0 && (
          <div class="w-full flex items-center justify-center mx-auto mb-6">
            <Social source={social} className="social-icons" />
          </div>
        )}

        {/* QR Code Section */}
        <div class="md:block mt-6 mb-6">
          <div class="text-center">
            <div class="inline-block p-2 border-2 border-dashed border-border dark:border-darkmode-border rounded-lg">
              <img
                src="/images/qr-vcard.png"
                alt="QR Code"
                width={128}
                height={128}
                class="block"
              />
            </div>
            <p class="text-xs text-gray-500 dark:text-gray-400 text-center mt-2">
              Scan to add directly to your contacts
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const downloadVCard = () => {
    const contactData = {
      name: document.querySelector("h1")?.textContent?.trim() || "",
      company: document.querySelector(".text-white.text-base")?.textContent?.trim() || "",
      title: Array.from(document.querySelectorAll(".text-white.text-base"))[1]?.textContent?.trim() || "",
      email: document.querySelector('[href^="mailto:"]')?.getAttribute("href")?.replace("mailto:", "") || "",
      phone: document.querySelector('[href^="tel:"]')?.getAttribute("href")?.replace("tel:", "") || "",
      location: document.querySelector('[class*="whitespace-pre-line"]')?.textContent?.trim() || "",
      website: document.querySelector('[href^="https://"]')?.getAttribute("href")?.replace("https://", "") || "",
      bio: document.querySelector(".text-\\[15px\\]")?.textContent?.trim() || "",
    };

    const vCard = `BEGIN:VCARD
VERSION:3.0
FN:${contactData.name}
ORG:${contactData.company}
TITLE:${contactData.title}
EMAIL:${contactData.email}
TEL:${contactData.phone}
ADR:;;${contactData.location};;;;
URL:https://${contactData.website}
NOTE:${contactData.bio.replace(/\n/g, " ")}
END:VCARD`;

    const blob = new Blob([vCard], { type: "text/vcard;charset=utf-8" });
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `${contactData.name.replace(/\s+/g, "_")}_contact.vcf`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
  };

  const handleShare = async () => {
    const shareText = document.getElementById("share-text");
    if (navigator.share) {
      if (shareText) shareText.textContent = "Sharing...";
      try {
        await navigator.share({
          title: `${document.querySelector("h1")?.textContent || ""} - Contact Card`,
          text: `Connect with ${document.querySelector("h1")?.textContent || ""}`,
          url: window.location.href,
        });
      } catch (error) {
        console.log("Share cancelled");
      } finally {
        if (shareText) shareText.textContent = "Share";
      }
    } else {
      navigator.clipboard.writeText(window.location.href);
      if (shareText) shareText.textContent = "Copied!";
      setTimeout(() => {
        if (shareText) shareText.textContent = "Share";
      }, 2000);
    }
  };

  const downloadBtn = document.getElementById("download-vcard-btn");
  if (downloadBtn) {
    downloadBtn.addEventListener("click", (e) => {
      e.preventDefault();
      downloadVCard();
    });
  }

  const shareBtn = document.getElementById("share-btn");
  if (shareBtn) {
    shareBtn.addEventListener("click", (e) => {
      e.preventDefault();
      handleShare();
    });
  }

  const copyEmail = async () => {
    // Get the email value from the data-email attribute
    const emailDisplay = document.getElementById("email-display");
    const emailValue = emailDisplay?.getAttribute("data-email") || "";

    if (!emailValue) return;

    try {
      await navigator.clipboard.writeText(emailValue);
      const emailLabel = document.getElementById("email-label");
      if (emailLabel) {
        const originalText = emailLabel.textContent;
        emailLabel.textContent = "Copied!";
        emailLabel.classList.add("text-[#01afb6]");
        setTimeout(() => {
          emailLabel.textContent = originalText;
          emailLabel.classList.remove("text-[#01afb6]");
        }, 2000);
      }
    } catch (error) {
      console.error("Failed to copy email:", error);
    }
  };

  const emailDisplayEl = document.getElementById("email-display");
  if (emailDisplayEl) {
    emailDisplayEl.addEventListener("click", copyEmail);
  }
</script>
